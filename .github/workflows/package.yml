name: Build and Publish Apt Package
on:
  push:
    branches:
      - main
jobs:
  build-and-publish:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
        with:
          ref: main
        runs:
          node-version: '16.x'
      
      - name: Setup Node.js
        uses: actions/setup-node@v2
        with:
          node-version: '16.x'
          
      - name: Install dependencies
        run: |
          sudo apt-get update && sudo apt-get install -y build-essential dh-make devscripts fakeroot
      
      - name: Build package
        run: |
          dpkg-buildpackage -uc -us
      
      - name: Publish package
        uses: actions/upload-artifact@v2
        with:
          name: ${{ github.event.repository.name }}_${{ github.run_number }}
          path: '*.deb'
          
      - name: Publish to Github Packages
        uses: actions/github-script@v4
        env:
          PACKAGE_NAME: ${{ github.event.inputs.package_name }}
        with:
          script: |
            const { data } = await github.packages.publishPackage({
              package_type: 'deb',
              name: process.env.PACKAGE_NAME,
              version: '${{ github.run_number }}',
              release_type: 'stable',
              package_file: `${{ github.event.repository.name }}_${{ github.run_number }}.deb`,
            })
            console.log(`Published package ${data.package.name} with version ${data.package.version}`)
